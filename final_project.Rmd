---
title: "Final Project"
author: "Michael Dunst & Sofia Fasullo"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })    
---

```{r setup, echo=FALSE, install= TRUE, cache=TRUE, message=FALSE, results=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
# Load some libraries
rm(list = ls())
library(tidycensus)
library(dplyr)
library(viridis)
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(stargazer)
options(scipen=999) #scientific notation off

# Functions and data directory
census_api_key("8c8e36c4b5046c4d7f8a5d9f0f7a7d0ddde86e8b")

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")

```



```{r import listings}

listings <- read.csv("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/listings.csv")

listing_details <- read.csv("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/listings_details.csv")
```

```{r clean data}

listing_details <- listing_details %>%
  select(1,23,26,29,39,40,49,50,52:57,60,61,80,96)

listings <- listings %>%
  select(1)

full_listings <- merge(listings,listing_details,by="id")

full_listings <- full_listings %>% mutate(price = price %>% str_remove_all("[$,]") %>% as.numeric())

full_listings.sf <- st_as_sf(full_listings,coords=c("longitude","latitude"),crs="EPSG:28992")
```



```{r data exploration}
ggplot(full_listings, aes(review_scores_rating,price))+
  geom_jitter(height=1,width=1)+
  xlim(50,100)+
  ylim(0,1000)+
  labs(x="User Ratings", y="Nightly Rate",
             title = "User Experience vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#General increase in price as ratings go up.
  
ggplot(full_listings, aes(bedrooms,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Bedrooms", y="Nightly Rate",
             title = "Number of Bedrooms vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#No general trend by number of bedrooms.

full_listings %>%
  drop_na(host_response_time) %>% #This drop na isn't working as intended
ggplot(., aes(host_response_time,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Bedrooms", y="Nightly Rate",
             title = "Number of Bedrooms vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#No association between responsiveness and nightly rate.

full_listings %>% 
	group_by(property_type) %>% 
	summarise(count = n()) %>% 
	ggplot(aes(x = reorder(property_type,(count)), y = count)) + 
		geom_bar(stat = 'identity', fill="darkgreen") + 
		theme_minimal()+
  scale_y_log10()+
  labs(x="Property Type", y="Count (Log-scaled)",
             title = "Types of Airbnb Properties",
             subtitle = "Amsterdam")+
  coord_flip()

ggplot(full_listings, aes(property_type,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Property Type", y="Nightly Rate",
             title = "Type of Property vs. Price",
             subtitle = "Amsterdam Airbnbs")+
  coord_flip()+
  theme_minimal()
#Nothing sticks out...except lighthouses!
```


```{r new features}
AMS_neighborhoods.sf <- 
  st_read("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/neighbourhoods.geojson") %>%
  st_transform(st_crs(full_listings.sf))

ggplot() +
  geom_sf(data = AMS_neighborhoods.sf, aes(fill=neighbourhood))
```

```{r monuments}

monuments.sf <- st_read("https://map.data.amsterdam.nl/maps/monumenten?REQUEST=GetFeature&SERVICE=wfs&version=2.0.0&typenames=monument_coordinaten&outputformat=geojson&srsName=urn:ogc:def:crs:EPSG::4326") %>%
  st_transform(st_crs(full_listings.sf))

ggplot() +
  geom_sf(data = monuments.sf, aes(color=monumentstatus))

monuments.sf <- monuments.sf %>% filter(st_geometry_type(geometry)=="POINT")

full_listings.sf <-
  full_listings.sf %>% 
    mutate(
      monuments_nn3 = nn_function(st_coordinates(full_listings.sf), 
                              st_coordinates(monuments.sf), k = 3))

ggplot()+
  geom_sf(data = AMS_neighborhoods.sf, aes(fill=neighbourhood))+
  geom_sf(data = monuments.sf, aes(color=monumentstatus))

intersection <- st_intersection(x = AMS_neighborhoods.sf, y = monuments.sf)


neighborhood_monuments <-
   intersection %>% 
  group_by(neighbourhood) %>% 
  count()

full_listings.sf <- 
  merge(full_listings.sf,st_drop_geometry(neighborhood_monuments),by.x="neighbourhood_cleansed",by.y="neighbourhood")

```


```{r graph monument}

ggplot()+
  geom_point(data=full_listings.sf,mapping=aes(n,log10(price)))+
  labs(x="# of Monuments", y="Nightly Rate",
             title = "Monuments in Vicinity vs. Price",
             subtitle = "Amsterdam Airbnbs")+
  theme_minimal()

ggplot()+
  geom_histogram(data=full_listings.sf,mapping=aes(log10(price)))
```



```{r corr table}
numericVars <- select_if(st_drop_geometry(full_listings.sf), is.numeric) %>% na.omit()

ggcorrplot(
  round(cor(numericVars), 1),
  p.mat = cor_pmat(numericVars),
  colors = c("deepskyblue", "grey100", "firebrick1"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation Matrix of Numeric Variables", tl.cex = 0.5, tl.col = "black") +
  plotTheme()



```
































