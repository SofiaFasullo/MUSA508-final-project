---
title: "Final Project"
author: "Michael Dunst & Sofia Fasullo"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
knit: (function(input, encoding) {
    rmarkdown::render(
      input = input,
      encoding = encoding,
      envir = globalenv()
    )
  })    
---

```{r setup, echo=FALSE, install= TRUE, cache=TRUE, message=FALSE, results=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
# Load some libraries
rm(list = ls())
library(tidycensus)
library(dplyr)
library(viridis)
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(stargazer)
library(readr)
options(scipen=999) #scientific notation off

# Functions and data directory
census_api_key("8c8e36c4b5046c4d7f8a5d9f0f7a7d0ddde86e8b")

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#981FAC","#CB0F8B","#FF006A","#FE4C35","#FE9900")
palette4 <- c("#981FAC","#FF006A","#FE4C35","#FE9900")
palette2 <- c("#981FAC","#FF006A")

```



```{r import listings}

listings <- read_csv("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/listings.csv")

listing_details <- read_csv("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/listings_details.csv")
```

```{r clean data}

listing_details <- listing_details %>%
  select(1,23,26,29,39,40,49,50,52:57,60,61,80,96)

listings <- listings %>%
  select(1)

full_listings <- merge(listings,listing_details,by="id")

full_listings <- full_listings %>% mutate(price = price %>% str_remove_all("[$,]") %>% as.numeric())

full_listings.sf <- st_as_sf(full_listings,coords=c("longitude","latitude"),crs="EPSG:28992")
```



```{r data exploration}
ggplot(full_listings, aes(review_scores_rating,price))+
  geom_jitter(height=1,width=1)+
  xlim(50,100)+
  ylim(0,1000)+
  labs(x="User Ratings", y="Nightly Rate",
             title = "User Experience vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#General increase in price as ratings go up.
  
ggplot(full_listings, aes(bedrooms,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Bedrooms", y="Nightly Rate",
             title = "Number of Bedrooms vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#No general trend by number of bedrooms.

full_listings %>%
  drop_na(host_response_time) %>% #This drop na isn't working as intended
ggplot(., aes(host_response_time,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Host response time", y="Nightly Rate",
             title = "Host Eagerness to Rent vs. Price",
             subtitle = "Amsterdam Airbnbs")+ 
  theme_minimal()
#No association between responsiveness and nightly rate.

full_listings %>% 
	group_by(property_type) %>% 
	summarise(count = n()) %>% 
	ggplot(aes(x = reorder(property_type,(count)), y = count)) + 
		geom_bar(stat = 'identity', fill="darkgreen") + 
		theme_minimal()+
  scale_y_log10()+
  labs(x="Property Type", y="Count (Log-scaled)",
             title = "Types of Airbnb Properties",
             subtitle = "Amsterdam")+
  coord_flip()

ggplot(full_listings, aes(property_type,price))+ 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", fill="darkgreen")+
  labs(x="Property Type", y="Nightly Rate",
             title = "Type of Property vs. Price",
             subtitle = "Amsterdam Airbnbs")+
  coord_flip()+
  theme_minimal()
#Nothing sticks out...except lighthouses!
```
some notes:
lighthouse looks like an outlier

```{r new features}
AMS_neighborhoods.sf <- 
  st_read("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/neighbourhoods.geojson") %>%
  st_transform(st_crs(full_listings.sf))

ggplot() +
  geom_sf(data = AMS_neighborhoods.sf, aes(fill=neighbourhood))
```

```{r monuments}

monuments.sf <- st_read("https://github.com/SofiaFasullo/MUSA508-final-project/raw/main/landmarks.json") %>%
  st_transform(st_crs(full_listings.sf))


ggplot() +
  geom_sf(data = monuments.sf, aes(color=monumentstatus))

monuments.sf <- monuments.sf %>% filter(st_geometry_type(geometry)=="POINT")

full_listings.sf <-
  full_listings.sf %>% 
    mutate(
      monuments_nn3 = nn_function(st_coordinates(full_listings.sf), 
                              st_coordinates(monuments.sf), k = 3))

ggplot()+
  geom_sf(data = AMS_neighborhoods.sf, aes(fill=neighbourhood))+
  geom_sf(data = monuments.sf, aes(color=monumentstatus))

intersection <- st_intersection(x = AMS_neighborhoods.sf, y = monuments.sf)


neighborhood_monuments <-
   intersection %>% 
  group_by(neighbourhood) %>% 
  count()

full_listings.sf <- 
  merge(full_listings.sf,st_drop_geometry(neighborhood_monuments),by.x="neighbourhood_cleansed",by.y="neighbourhood")

```


```{r graph monument}

ggplot()+
  geom_point(data=full_listings.sf,mapping=aes(n,price))+
  labs(x="# of Monuments", y="Nightly Rate",
             title = "Monuments in Vicinity vs. Price",
             subtitle = "Amsterdam Airbnbs")+
  theme_minimal()

ggplot()+
  geom_histogram(data=full_listings.sf,mapping=aes(price))

ggplot()+
  geom_histogram(data=full_listings.sf,mapping=aes(log10(price)))

#clearly, taking the log of price normalizes the variable, wwhich is an assumption of regression models

#create a new variable of the log of price
full_listings.sf = full_listings.sf %>% mutate(
  logPrice = log10(price)
)
```



```{r corr table}
numericVars <- select_if(st_drop_geometry(full_listings.sf), is.numeric) %>% na.omit()

ggcorrplot(
  round(cor(numericVars), 1),
  p.mat = cor_pmat(numericVars),
  colors = c("deepskyblue", "grey100", "firebrick1"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation Matrix of Numeric Variables", tl.cex = 0.5, tl.col = "black") +
  plotTheme()



```


```{r}
#should split dataset into training and testing before

fullOLS.lm = lm(logPrice~.,data=st_drop_geometry(select(full_listings.sf,-price)))
#summary(fullOLS.lm)#this makes me cry

#variable thoughts
#host_since turn into time been a host
#host it superhost turn into 0-1
#delete neighborhood, lat, long, square feet

fullOLS.lm2 = lm(logPrice~.,data= full_listings.sf %>% dplyr :: select(-c(host_since, neighbourhood, monuments_nn3, price)) %>% st_drop_geometry() %>%  na.omit())
summary(fullOLS.lm2)
```

```{r}
#the model based on our diagnostics that would be useful
#the way we calculated n made it perfectly collinear with the neighborhood, wwhich is not helpful for us

trimmedOLS.lm = lm(logPrice~host_response_time+host_is_superhost+neighbourhood_cleansed+bedrooms+review_scores_rating+reviews_per_month, data=st_drop_geometry(full_listings.sf) %>% drop_na())
summary(trimmedOLS.lm)
#result: trying to use only the variables we think are good makes the R^2 drop a lot
```
#some feature engineering
```{r}
full_listings.sf = full_listings.sf %>% mutate(
  superhost = ifelse(host_is_superhost=="t",1,0),
  year = as.numeric(separate(host_since,into=c('year'),sep=(4)))
  )

```

```{r}
#some notes to move forward!
#Chapter 4 of the textbook talks about fixed neighborhood effects and how to account for them (oour variable n is a fixed neighborhood effect)
#chapter 4 also goes into predicting price using spatial clustering of price
```

#spatial clustering of price
```{r}
coords <- st_coordinates(full_listings.sf) 

neighborList <- knn2nb(knearneigh(coords, 3)) #3 nearest neighbors

spatialWeights <- nb2listw(neighborList, style="W")

full_listings.sf$lagPrice <- lag.listw(spatialWeights, full_listings.sf$price) 

ggplot(data=full_listings.sf,mapping = aes(x=lagPrice,y=price)) + 
  geom_point() + geom_abline()
#doesn't seem super helpful

full_listings.sf$lagLogPrice <- lag.listw(spatialWeights, round(full_listings.sf$logPrice,digits = 10)) #non finite?

ggplot(data=full_listings.sf,mapping = aes(x=lagLogPrice,y=logPrice)) + 
  geom_point() + geom_abline()
```

```{r}
#not sure how to get this to work

left_join(
  st_drop_geometry(full_listings.sf) %>%
    group_by(neighbourhood_cleansed) %>%
    summarize(meanPrice = mean(price, na.rm = T)),
  mutate(full_listings.sf, predict.fe = 
                        predict(lm(logPrice ~ neighborhood_cleansed, data = full_listings.sf) %>% exp(), 
                        full_listings.sf)) %>%
    st_drop_geometry %>%
    group_by(neighborhood_cleansed) %>%
      summarize(meanPrediction = mean(predict.fe))) %>%
      kable() %>% kable_styling()
```

























